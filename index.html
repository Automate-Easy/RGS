<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Conectar WhatsApp ‚Ä¢ Z-API (com Logs)</title>
    <style>
      body { font-family: system-ui, sans-serif; background: #0b1020; color: #e7ecf7; margin:0; }
      .wrap { max-width: 900px; margin: auto; padding: 20px; }
      .panel { background:#131a2a; padding:16px; margin-bottom:20px; border-radius:10px; }
      .muted { color:#95a0b4; font-size:14px; }
      .qr { width: 260px; height: 260px; background:#0c1322; display:flex; align-items:center; justify-content:center; margin-top:10px; }
      .qr img { max-width:100%; max-height:100%; }
      .chip { display:inline-block; background:#2ecc71; color:white; padding:4px 10px; border-radius:20px; margin-top:10px; }
      button { padding:8px 14px; border-radius:8px; cursor:pointer; }
      #logBox { background:#0c1322; padding:10px; border-radius:8px; font-size:13px; height:220px; overflow:auto; white-space:pre-wrap; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="panel">
        <h2>Estado da Inst√¢ncia</h2>
        <div id="stateText" class="muted">Carregando‚Ä¶</div>
        <div id="qrBox" class="qr"></div>
        <div id="connectedWrap" hidden>
          <div class="chip">üü¢ Inst√¢ncia conectada</div>
        </div>
        <button id="btnDisconnect" disabled>Desconectar inst√¢ncia</button>
      </div>

      <div class="panel">
        <h2>Logs HTTP</h2>
        <div id="logBox"></div>
      </div>
    </div>

    <script>
      const CONFIG = {
        baseUrl: 'https://api.z-api.io',
        instanceId: '3E4BB947350271DE447A5E06DC0B5B06', // ‚úÖ seu instance ID
        accountToken: 'Ffa07a322c30c40f69a39b5700df9bea8S', // ‚úÖ token da CONTA
        instanceToken: 'C52D3A6CA946485B7D1CA33A',          // ‚úÖ token da INST√ÇNCIA
        authScheme: 'Bearer',
        pollMs: 5000,
        endpoints: {
          status(base, id) { return `${base}/instances/${id}/status`; },
          qr(base, id)     { return `${base}/instances/${id}/qr-code`; },
          disconnect(base, id) { return `${base}/instances/${id}/disconnect`; },
        },
        instanceTokenHeader: 'X-Instance-Token'
      };

      const els = {
        stateText: document.getElementById('stateText'),
        qrBox: document.getElementById('qrBox'),
        connectedWrap: document.getElementById('connectedWrap'),
        btnDisconnect: document.getElementById('btnDisconnect'),
        logBox: document.getElementById('logBox'),
      };

      function log(msg) {
        const time = new Date().toLocaleTimeString();
        els.logBox.textContent += `[${time}] ${msg}\n`;
        els.logBox.scrollTop = els.logBox.scrollHeight;
      }

      function authHeaders() {
        const h = {
          'Accept': 'application/json',
          'Authorization': `${CONFIG.authScheme} ${CONFIG.accountToken}`
        };
        if (CONFIG.instanceToken) {
          h[CONFIG.instanceTokenHeader] = CONFIG.instanceToken;
        }
        return h;
      }

      async function getJSON(url) {
        const headers = authHeaders();
        log(`‚û°Ô∏è GET ${url}\nHeaders: ${JSON.stringify(headers)}`);
        try {
          const res = await fetch(url, { headers, cache: 'no-store' });
          const text = await res.text();
          log(`‚¨ÖÔ∏è ${res.status} ${res.statusText}: ${text}`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          return JSON.parse(text);
        } catch (err) {
          log(`‚ùå Erro: ${err.message}`);
          throw err;
        }
      }

      async function fetchStatusAndUpdate() {
        try {
          const data = await getJSON(CONFIG.endpoints.status(CONFIG.baseUrl, CONFIG.instanceId));
          const connected = data.connected ?? data.isConnected ?? false;
          els.stateText.textContent = connected ? 'Conectado' : 'Desconectado';
          els.connectedWrap.hidden = !connected;
          els.btnDisconnect.disabled = !connected;
          if (!connected) await renderQr();
        } catch (err) {
          els.stateText.textContent = 'Erro ao obter status';
        }
      }

      async function renderQr() {
        els.qrBox.innerHTML = 'Carregando QR‚Ä¶';
        try {
          const data = await getJSON(CONFIG.endpoints.qr(CONFIG.baseUrl, CONFIG.instanceId));
          const dataUrl = data.qrCode || (data.base64 ? `data:image/png;base64,${data.base64}` : null);
          if (dataUrl) {
            els.qrBox.innerHTML = `<img src="${dataUrl}" alt="QR Code" />`;
          } else {
            els.qrBox.textContent = 'QR n√£o encontrado no retorno.';
          }
        } catch (err) {
          els.qrBox.textContent = 'Erro ao carregar QR.';
        }
      }

      async function disconnectInstance() {
        els.btnDisconnect.disabled = true;
        const url = CONFIG.endpoints.disconnect(CONFIG.baseUrl, CONFIG.instanceId);
        const headers = authHeaders();
        log(`‚û°Ô∏è POST ${url}\nHeaders: ${JSON.stringify(headers)}`);
        try {
          const res = await fetch(url, { method: 'POST', headers });
          const text = await res.text();
          log(`‚¨ÖÔ∏è ${res.status} ${res.statusText}: ${text}`);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          els.stateText.textContent = 'Desconectado';
          els.connectedWrap.hidden = true;
        } catch (err) {
          log(`‚ùå Erro ao desconectar: ${err.message}`);
        } finally {
          els.btnDisconnect.disabled = false;
        }
      }

      els.btnDisconnect.addEventListener('click', disconnectInstance);

      (async function init() {
        await fetchStatusAndUpdate();
        setInterval(fetchStatusAndUpdate, CONFIG.pollMs);
      })();
    </script>
  </body>
</html>
