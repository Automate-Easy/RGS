<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cobranças RGS . Conectar WhatsApp</title>
  <style>
    :root{
      --bg:#eef2f4; --card:#ffffff; --muted:#7a8794;
      --brand:#0c6a57; --brand-2:#0b5a49;
      --ok:#2ecc71; --warn:#e67e22; --shadow:0 12px 28px rgba(12,26,44,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:16px/1.4 system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif;color:#132433;display:grid;place-items:center;min-height:100dvh;padding:20px}
    .card{width:100%;max-width:420px;background:var(--card);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;border:1px solid #e5eaef}
    .card-head{background:var(--brand);color:#fff;padding:18px 20px;text-align:center}
    .card-head h1{margin:0;font-size:20px;line-height:1.2}
    .card-body{padding:20px}
    .status-box{background:#f2f5f7;border:1px solid #e6edf2;border-radius:14px;padding:18px;text-align:center}
    .status-title{font-size:13px;letter-spacing:.4px;color:#8a98a8;margin-bottom:14px;font-weight:700}
    /* QR area */
    .qr{width:260px;height:260px;margin:0 auto;border-radius:12px;background:#fff;display:grid;place-items:center;border:1px dashed #cfd8e3;overflow:hidden}
    .qr img{width:100%;height:100%;object-fit:contain}
    /* Check icon */
    .ok{width:96px;height:96px;border-radius:50%;display:grid;place-items:center;margin:6px auto 4px;background:rgba(46,204,113,.15);border:2px solid rgba(46,204,113,.35)}
    .ok svg{width:52px;height:52px;fill:var(--ok)}
    .divider{height:4px;border:0;border-radius:999px;background:#e6edf2;margin:18px 0}
    .msg{color:#6b7a8b;text-align:center;font-size:14px}
    /* Botão desconectar (só aparece conectado) */
    .actions{display:flex;justify-content:center;margin-top:12px}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 16px;font-weight:700;cursor:pointer;transition:filter .15s ease,transform .05s ease}
    .btn-danger{background:#e74c3c;color:#fff}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <div class="card" id="app">
    <div class="card-head">
      <h1>Cobranças RGS<br/>Conectar WhatsApp</h1>
    </div>
    <div class="card-body">
      <div class="status-box">
        <div class="status-title">STATUS DO DISPOSITIVO</div>

        <!-- conectado -->
        <div id="connectedWrap" hidden>
          <div class="ok" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="M9 16.2l-3.5-3.5-1.4 1.4L9 19 20 8l-1.4-1.4z"/></svg>
          </div>
          <div class="actions">
            <button id="btnDisconnect" class="btn btn-danger">Desconectar instância</button>
          </div>
        </div>

        <!-- desconectado (mostra QR) -->
        <div id="qrWrap" hidden>
          <div class="qr" id="qrBox"><span style="color:#9aa7b4">Carregando QR…</span></div>
        </div>
      </div>

      <div class="divider"></div>
      <p class="msg" id="statusMsg">Aguardando status…</p>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const CONFIG = {
      baseUrl: 'https://api.z-api.io',
      instanceId: '3D67BF8C04F6A0AE58362272D360C213',
      instanceToken: '5FB1E9C5F40F3DA299FB1C4A',
      accountToken: 'Ffa07a322c30c40f69a39b5700df9bea8S',
      pollMs: 5000,
      endpoints: {
        status(b,id,t){ return `${b}/instances/${id}/token/${t}/status`; },
        qrImage(b,id,t){ return `${b}/instances/${id}/token/${t}/qr-code/image`; },
        disconnect(b,id,t){ return `${b}/instances/${id}/token/${t}/disconnect`; }
      }
    };

    // ===== UI refs =====
    const els = {
      connectedWrap: document.getElementById('connectedWrap'),
      qrWrap: document.getElementById('qrWrap'),
      qrBox: document.getElementById('qrBox'),
      statusMsg: document.getElementById('statusMsg'),
      btnDisconnect: document.getElementById('btnDisconnect')
    };

    // ===== helpers =====
    function headers(){ return { 'Accept':'application/json', 'Client-Token': CONFIG.accountToken }; }

    function setConnectedUI(connected){
      if (connected){
        els.connectedWrap.hidden = false;
        els.qrWrap.hidden = true;
        els.qrBox.innerHTML = '';
        els.statusMsg.textContent = 'Conexão estabelecida com sucesso';
      } else {
        els.connectedWrap.hidden = true;
        els.qrWrap.hidden = false;
        els.statusMsg.textContent = 'Instância desconectada — escaneie o QR para conectar';
      }
    }

    function parseConnected(data){
      if (typeof data.connected === 'boolean') return data.connected;
      if (typeof data.isConnected === 'boolean') return data.isConnected;
      const s = String(data.state ?? data.status ?? data.value ?? '').toUpperCase();
      return s.includes('CONNECT');
    }

    // ===== network =====
    async function getJSON(url){
      const res = await fetch(url, { headers: headers(), cache:'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function fetchStatus(){
      const url = CONFIG.endpoints.status(CONFIG.baseUrl, CONFIG.instanceId, CONFIG.instanceToken);
      const data = await getJSON(url);
      return parseConnected(data);
    }

    async function renderQr(){
      els.qrBox.innerHTML = '<span style="color:#9aa7b4">Carregando QR…</span>';
      const url = CONFIG.endpoints.qrImage(CONFIG.baseUrl, CONFIG.instanceId, CONFIG.instanceToken);
      const res = await fetch(url, { headers: headers(), cache:'no-store' });
      if (!res.ok) { els.qrBox.innerHTML = '<span style="color:#c0392b">Falha ao carregar QR</span>'; return; }

      const ct = res.headers.get('content-type') || '';
      let base64;
      if (ct.includes('application/json')){
        const j = await res.json();
        base64 = j.base64 || j.image || j.qrCode || j.value;
      } else {
        base64 = (await res.text()).trim();
      }
      if (!base64){ els.qrBox.textContent = 'QR não encontrado.'; return; }
      const dataUrl = base64.startsWith('data:') ? base64 : `data:image/png;base64,${base64}`;
      els.qrBox.innerHTML = `<img src="${dataUrl}" alt="QR Code"/>`;
    }

    async function disconnectInstance(){
      try{
        els.btnDisconnect.disabled = true;
        const url = CONFIG.endpoints.disconnect(CONFIG.baseUrl, CONFIG.instanceId, CONFIG.instanceToken);
        const res = await fetch(url, { method:'GET', headers: headers() });
        // independentemente do corpo, depois de desconectar, atualiza a UI
      }catch(err){
        // opcional: exibir mensagem de erro
      }finally{
        els.btnDisconnect.disabled = false;
        // força checar o status logo após desconectar
        await tick();
      }
    }

    // ===== loop =====
    async function tick(){
      try{
        const connected = await fetchStatus();
        setConnectedUI(connected);
        if (!connected) { await renderQr(); }
      }catch(e){
        setConnectedUI(false);
        try { await renderQr(); } catch {}
      }
    }

    // eventos
    els.btnDisconnect.addEventListener('click', disconnectInstance);

    // start
    tick();
    setInterval(tick, CONFIG.pollMs);
  </script>
</body>
</html>
