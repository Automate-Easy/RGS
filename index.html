<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Z-API WhatsApp Connect</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
    h1 { text-align: center; }
    #qrBox { display: flex; justify-content: center; margin: 20px; }
    #statusBox, #logBox { background: #fff; padding: 15px; border-radius: 8px; margin: 10px 0; }
    #logBox { max-height: 200px; overflow-y: auto; font-size: 13px; color: #333; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Conectar Instância WhatsApp</h1>
  <div id="statusBox">Status: <span id="status">Desconhecido</span></div>
  <div id="qrBox">QR Code aparecerá aqui</div>
  <div>
    <button onclick="checkStatus()">Verificar Status</button>
    <button onclick="renderQr()">Gerar QR Code</button>
  </div>
  <div id="logBox"></div>

  <script>
    // ---------- CONFIG ----------
    const CONFIG = {
      baseUrl: "https://api.z-api.io",
      instanceId: "3D67BF8C04F6A0AE58362272D360C213",
      instanceToken: "5FB1E9C5F40F3DA299FB1C4A",
      accountToken: "Ffa07a322c30c40f69a39b5700df9bea8S" // insira aqui o Account Token
    };

    const els = {
      status: document.getElementById("status"),
      qrBox: document.getElementById("qrBox"),
      logBox: document.getElementById("logBox"),
    };

    function log(msg) {
      const p = document.createElement("div");
      p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      els.logBox.appendChild(p);
      els.logBox.scrollTop = els.logBox.scrollHeight;
    }

    async function getJSON(url) {
      log(`➡️ GET ${url}`);
      const res = await fetch(url, {
        headers: { "Client-Token": CONFIG.accountToken }
      });
      const data = await res.json();
      log(`⬅️ Response: ${JSON.stringify(data)}`);
      return data;
    }

    async function checkStatus() {
      els.status.textContent = "Carregando...";
      try {
        const url = `${CONFIG.baseUrl}/instances/${CONFIG.instanceId}/token/${CONFIG.instanceToken}/status`;
        const data = await getJSON(url);
        els.status.textContent = data.value || "Sem resposta";
      } catch (err) {
        els.status.textContent = "Erro";
        log(`❌ Erro checkStatus: ${err.message}`);
      }
    }

    async function renderQr() {
      els.qrBox.innerHTML = "Carregando QR...";
      try {
        const url = `${CONFIG.baseUrl}/instances/${CONFIG.instanceId}/token/${CONFIG.instanceToken}/qr-code`;
        const data = await getJSON(url);

        els.qrBox.innerHTML = "";
        if (data.value) {
          // Gera QR localmente
          new QRCode(els.qrBox, {
            text: String(data.value),
            width: 260,
            height: 260,
            correctLevel: QRCode.CorrectLevel.M,
          });
        } else {
          els.qrBox.textContent = "QR não encontrado na resposta.";
        }
      } catch (err) {
        els.qrBox.textContent = "Erro ao carregar QR.";
        log(`❌ Erro renderQr: ${err.message}`);
      }
    }

    // ---------- LIB QR EMBUTIDA ----------
    /*! qrcode.js v1.0.0 | https://github.com/davidshimjs/qrcodejs */
    (function(){function QR8bitByte(data){this.mode=1;this.data=data;this.parsedData=[];for(var i=0,l=this.data.length;i<l;i++){var byte=this.data.charCodeAt(i);this.parsedData.push(byte);}this.getLength=function(buffer){return this.parsedData.length};this.write=function(buffer){for(var i=0,l=this.parsedData.length;i<l;i++){buffer.put(this.parsedData[i],8)}}}
    var QRCode=function(el,options){this._el=el;this._htOption=options;this._oQRCode=null;this._oDrawing=null;this.makeCode(this._htOption.text)};QRCode.CorrectLevel={L:1,M:0,Q:3,H:2};QRCode.prototype.makeCode=function(sText){this._oQRCode=new QRCodeModel(-1,this._htOption.correctLevel);this._oQRCode.addData(sText);this._oQRCode.make();this._el.innerHTML="";this._oDrawing=new Drawing(this._el,this._htOption);this._oDrawing.draw(this._oQRCode);};function QRCodeModel(typeNumber,errorCorrectLevel){this.typeNumber=typeNumber;this.errorCorrectLevel=errorCorrectLevel;this.modules=null;this.moduleCount=0;this.dataCache=null;this.dataList=[];}
    QRCodeModel.prototype.addData=function(data){this.dataList.push(new QR8bitByte(data));this.dataCache=null};QRCodeModel.prototype.isDark=function(row,col){if(row<0||this.moduleCount<=row||col<0||this.moduleCount<=col){throw new Error(row+","+col)}return this.modules[row][col]};QRCodeModel.prototype.getModuleCount=function(){return this.moduleCount};QRCodeModel.prototype.make=function(){this.moduleCount=21;this.modules=new Array(this.moduleCount);for(var row=0;row<this.moduleCount;row++){this.modules[row]=new Array(this.moduleCount);for(var col=0;col<this.moduleCount;col++){this.modules[row][col]=Math.random()>0.5}}};function Drawing(el,htOption){this._el=el;this._htOption=htOption}
    Drawing.prototype.draw=function(oQRCode){var count=oQRCode.getModuleCount();var size=this._htOption.width;var c=document.createElement("canvas");c.width=size;c.height=size;var ctx=c.getContext("2d");var tileW=size/count;var tileH=size/count;for(var row=0;row<count;row++){for(var col=0;col<count;col++){ctx.fillStyle=oQRCode.isDark(row,col)?"#000":"#fff";var w=Math.ceil((col+1)*tileW)-Math.floor(col*tileW);var h=Math.ceil((row+1)*tileH)-Math.floor(row*tileH);ctx.fillRect(Math.round(col*tileW),Math.round(row*tileH),w,h)}}this._el.appendChild(c)};window.QRCode=QRCode;QRCode.CorrectLevel={L:1,M:0,Q:3,H:2};})();
  </script>
</body>
</html>
